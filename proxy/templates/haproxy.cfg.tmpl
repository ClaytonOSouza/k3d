global
  maxconn 2000
  log /dev/log local0             # send to syslog

defaults
  log global
  mode tcp
  retries 3
  timeout connect 3s
  timeout client 30s
  timeout server 30s
  option tcplog
  maxconn 2000

frontend kube-api
  mode tcp                        # tcp mode because of TLS termination at the API-Server
  bind :{{getenv "PORT"}}
  default_backend master-nodes

backend master-nodes
  balance roundrobin
  option httpchk GET /healthz                 # do http healthcheck (more informative/sensible), which also work with TCP backends (that talk http)
  http-check expect status 401
  default-server check ssl verify none maxconn 20 # enable healthcheck for all servers and set their number of max, concurrent connections to 20
  {{ $servers := split (getenv "SERVERS") "," }}{{range $servers}}
  server {{.}} {{.}}:{{getenv "PORT"}};
  {{end}}